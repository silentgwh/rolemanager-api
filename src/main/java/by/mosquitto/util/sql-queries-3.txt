-- Удаление таблиц, если они уже существуют (для чистого запуска)
DROP TABLE IF EXISTS role_privilege CASCADE;
DROP TABLE IF EXISTS profile_role CASCADE;
DROP TABLE IF EXISTS privilege CASCADE;
DROP TABLE IF EXISTS role CASCADE;
DROP TABLE IF EXISTS profile CASCADE;
DROP TABLE IF EXISTS app_user CASCADE;

-- Таблица APP_USER
CREATE TABLE app_user (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL
);

-- Таблица PROFILE
CREATE TABLE profile (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    comment VARCHAR(255),
    date_corr TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_corr BIGINT REFERENCES app_user(id) ON DELETE SET NULL
);

-- Таблица ROLE
CREATE TABLE role (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    type SMALLINT NOT NULL CHECK (type IN (0, 1)),
    comment VARCHAR(255),
    date_corr TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_corr BIGINT REFERENCES app_user(id) ON DELETE SET NULL
);

-- Таблица PRIVILEGE
CREATE TABLE privilege (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    type SMALLINT NOT NULL CHECK (type IN (0, 1)),
    name_2 VARCHAR(255),
    comment VARCHAR(255),
    date_corr TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_corr BIGINT REFERENCES app_user(id) ON DELETE SET NULL
);

-- Таблица PROFILE_ROLE (связь между PROFILE и ROLE)
CREATE TABLE profile_role (
    id_prof INTEGER NOT NULL REFERENCES profile(id) ON DELETE CASCADE,
    id_role INTEGER NOT NULL REFERENCES role(id) ON DELETE CASCADE,
    PRIMARY KEY (id_prof, id_role)
);

-- Таблица ROLE_PRIVILEGE (связь между ROLE и PRIVILEGE)
CREATE TABLE role_privilege (
    id_role INTEGER NOT NULL REFERENCES role(id) ON DELETE CASCADE,
    id_priv INTEGER NOT NULL REFERENCES privilege(id) ON DELETE CASCADE,
    PRIMARY KEY (id_role, id_priv)
);

-- Добавление внешних ключей в APP_USER (profile_id и role_id)
ALTER TABLE app_user
ADD COLUMN profile_id INTEGER REFERENCES profile(id) ON DELETE SET NULL,
ADD COLUMN role_id INTEGER REFERENCES role(id) ON DELETE SET NULL;
